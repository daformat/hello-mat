@use "/styles/lib/mixins";
@use "/styles/lib/link-mixins";

.media_component {
  --custom-ease: cubic-bezier(0.42, 0, 0.25, 1);
  --radius: 6px;
  --aspect-ratio: 16 / 4;
  --speed: var(--media-animation-speed, 1);
  grid-template-areas: "content";
  //max-width: var(--media-max-width);
  min-height: var(--collapsed-content-height, var(--single-line-height));
  min-width: var(--media-min-width);
  position: relative;

  button {
    border-color: transparent;
    border-width: 0;
  }

  &:not([data-collapsed-content-measured]) {
    display: grid;

    > .media_collapsed_content,
    .media_content_wrapper {
      grid-area: content;
    }

    .media_collapsed_content {
      position: initial;
    }
  }

  .placeholder {
    --c1: cubic-bezier(0.01, 0.3, 0.58, 1);
    --c2: cubic-bezier(0.25, 0.1, 0.25, 1);
    --animation-bumping-heart-2-transform: scale(1.1);
    --animation-bumping-heart-transform: scale(1.1);

    color: var(--color-placeholder-icon);
    opacity: 0.7;

    > * {
      animation: bumping-heart 1.6s var(--c1) infinite backwards,
        bumping-heart-2 1.6s var(--c2) infinite backwards;

      @include mixins.reduced-motion {
        animation: none;
      }
    }
  }

  .media_collapsed_content {
    display: flex;
    gap: 8px;
    left: 0;
    min-height: var(--single-line-height);
    opacity: 0;
    position: absolute;
    right: 0;
    top: 0;
    transition: opacity calc(0.3s / var(--speed)) ease-in-out;
    word-break: break-word;

    @include mixins.remove-transition;

    .icon {
      --size: 1.25em;

      align-items: initial;
      background-color: transparent;
      border-radius: 0;
      box-shadow: none;
      display: grid;
      font-size: inherit;
      height: var(--size);
      place-content: center;
      position: relative;
      top: calc(var(--single-line-height) * 0.5 - var(--size) * 0.5);
      transition: transform calc(0.2s / var(--speed)) var(--ease-out-cubic);
      width: var(--size);

      @include mixins.remove-transition;

      > * {
        grid-area: 1 / 1;
        height: var(--size);
        object-fit: cover;
        width: var(--size);
      }

      .img {
        background-size: cover;
        display: inline-block;
        height: var(--size);
        opacity: 0;
        transform: scale(0);
        transition: transform calc(0.2s / var(--speed)) ease-in-out;
        width: var(--size);

        @include mixins.remove-transition;

        &[data-variant="image"] {
          border-radius: 2px;
          box-shadow: inset 0 0 0 0.5px rgba(0, 0, 0, 0.2);
          overflow: hidden;
        }
      }

      .placeholder {
        transition: opacity calc(0.1s / var(--speed)) calc(0.1s / var(--speed))
            ease-in-out,
          transform calc(0.1s / var(--speed)) calc(0.1s / var(--speed));

        @include mixins.remove-transition;

        svg {
          height: var(--size);
          width: var(--size);
        }
      }

      // Add larger tap target
      &::before {
        background-color: transparent;
        content: "";
        inset: -0.75em;
        position: absolute;
      }

      &:focus-visible {
        transform: scale(1.2);
      }
    }

    a {
      @include link-mixins.link-with-arrow;
    }
  }

  .media_content_wrapper {
    aspect-ratio: var(--aspect-ratio);
    border-radius: var(--radius);
    height: 4em;
    max-height: var(--media-max-height);
    //max-width: var(--media-max-width);
    min-height: var(--media-min-height);
    min-width: var(--media-min-width);
    overflow: hidden;
    position: relative;
    transform-origin: top left;
    transition: height calc(0.3s / var(--speed)) var(--custom-ease),
      width calc(0.3s / var(--speed)) var(--custom-ease),
      aspect-ratio calc(0.3s / var(--speed)) var(--custom-ease),
      transform calc(0.3s / var(--speed)) var(--custom-ease),
      opacity calc(0.3s / var(--speed)) ease-in-out,
      background-color calc(0.3s / var(--speed)) ease-in-out
        calc(0.6s / var(--speed));
    width: 16em;

    @include mixins.remove-transition;

    .placeholder {
      --t: translate(-50%, -50%);

      left: 50%;
      opacity: 0;
      position: absolute;
      top: 50%;
      transform: var(--t) scale(0);
      transition: opacity calc(0.1s / var(--speed)) calc(0.1s / var(--speed))
          ease-in-out,
        transform calc(0.1s / var(--speed)) calc(0.1s / var(--speed))
          ease-in-out,
        left calc(0.2s / var(--speed)) ease-in-out calc(0.1s / var(--speed)),
        top calc(0.2s / var(--speed)) ease-in-out calc(0.1s / var(--speed));
      z-index: 1;

      @include mixins.remove-transition;
    }
  }

  .media_content {
    display: inline-flex;
    font-size: 0;

    img {
      max-width: initial;
    }
  }

  &:not([data-media-keep-aspect-ratio]) {
    .media_content {
      width: var(--media-component-width);

      > div {
        width: var(--media-component-width);
      }
    }
  }

  .media_content {
    transition: opacity calc(0.3s / var(--speed)) calc(0.2s / var(--speed))
        var(--ease-out-cubic),
      transform calc(0.3s / var(--speed)) calc(0.2s / var(--speed))
        var(--ease-out-cubic);

    @include mixins.remove-transition;

    > div iframe,
    img {
      border-radius: var(--radius);
      overflow: hidden;
      transform-origin: top left;
      transition: transform calc(0.3s / var(--speed)) var(--custom-ease);

      @include mixins.remove-transition;
    }
  }

  &[data-media-loading] {
    .media_content_wrapper {
      background-color: var(--color-empty);

      .placeholder {
        opacity: 0.5;
        transform: var(--t) scale(0.75);
      }
    }

    .media_content {
      opacity: 0;
      transform: scale(0);
    }
  }

  //---------------------------
  // When the media was loaded
  //---------------------------

  &:not([data-media-loading]) {
    .media_collapsed_content {
      .icon {
        .img {
          opacity: 1;
          transform: scale(1);
        }

        .placeholder {
          opacity: 0.5;
          transform: scale(0);
        }
      }
    }

    &:is([data-media-responsive]) {
      .media_content,
      .media_content_wrapper {
        height: 100%;
        width: 100%;
      }
    }

    .media_content_wrapper {
      min-height: initial;
      min-width: initial;
    }

    &[data-media-responsive="both"] {
      .media_content_wrapper {
        height: calc(var(--media-component-width) / var(--aspect-ratio));
      }

      .media_content {
        > div,
        iframe,
        img {
          height: calc(var(--media-component-width) / var(--aspect-ratio));
          width: 100%;
        }
      }
    }

    &[data-media-responsive="horizontal"] {
      .media_content_wrapper {
        height: var(--media-natural-height);
      }

      .media_content {
        height: initial;

        > div,
        iframe,
        img {
          width: 100%;
        }
      }
    }

    &[data-responsive="vertical"] {
      .media_content {
        > div,
        iframe,
        img {
          height: 100%;
        }
      }
    }

    &:not([data-media-responsive]) {
      .media_content_wrapper {
        height: var(--media-natural-height, 4em);
        width: var(--media-natural-width, 16em);
      }
    }

    &[data-media-keep-aspect-ratio] {
      --aspect-ratio: var(--media-natural-aspect-ratio);

      .media_content,
      .media_content_wrapper {
        aspect-ratio: var(--aspect-ratio);

        > div,
        iframe,
        img {
          aspect-ratio: var(--aspect-ratio);
        }
      }
    }
  }

  //-----------------
  // When collapsed
  //-----------------

  &[data-media-collapsed]:is(
      [data-media-responsive],
      :not([data-media-responsive])
    ) {
    .media_collapsed_content {
      opacity: 1;
      pointer-events: all;
    }

    .media_content_wrapper {
      aspect-ratio: initial;
      height: 0;
      opacity: 0;
      pointer-events: none;

      .media_content {
        > div iframe,
        img {
          transform: scale(0);
        }
      }
    }

    // -------------------------------
    // Provider related special-cases
    // -------------------------------
  }

  &:has([data-provider="twitter/x"]) {
    &:not([data-loading]) {
      .media_content_wrapper {
        .media_content {
          > div {
            > div {
              margin-block: 0 !important; // this is for twitter which insists on setting margins
            }
          }
        }
      }
    }
  }

  // ---------------------------------
  // MediaComponent specific animations
  // ---------------------------------

  @keyframes bumping-heart {
    0% {
      transform: none;
    }

    37.5% {
      transform: var(--animation-bumping-heart-transform);
    }
  }

  @keyframes bumping-heart-2 {
    37.5% {
      transform: var(--animation-bumping-heart-2-transform);
    }

    100% {
      transform: none;
    }
  }
}
